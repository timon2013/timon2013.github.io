"use strict";(self.webpackChunkpersonal_site=self.webpackChunkpersonal_site||[]).push([[285],{1687:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>c});var a=s(4848),t=s(8453);const o={},i="How to connect via Session Manager?",r={id:"SystemManager/How to connect via Session Manager",title:"How to connect via Session Manager?",description:"Minimal steps to connect",source:"@site/docs/SystemManager/03-How to connect via Session Manager.md",sourceDirName:"SystemManager",slug:"/SystemManager/How to connect via Session Manager",permalink:"/docs/SystemManager/How to connect via Session Manager",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/SystemManager/03-How to connect via Session Manager.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Ways of connecting to the server",permalink:"/docs/SystemManager/Ways of connecting to the server"},next:{title:"Servers on a private network without public access. Do we need a Bastion host?",permalink:"/docs/SystemManager/Servers on a private network without public access"}},l={},c=[{value:"Minimal steps to connect",id:"minimal-steps-to-connect",level:2},{value:"SSM Agent",id:"ssm-agent",level:3},{value:"IAM instance profile",id:"iam-instance-profile",level:3},{value:"Allow HTTPS traffic in Security Group",id:"allow-https-traffic-in-security-group",level:3},{value:"Connecting to instance",id:"connecting-to-instance",level:2},{value:"AWS Management Console",id:"aws-management-console",level:3},{value:"AWS Command Line Interface",id:"aws-command-line-interface",level:3},{value:"Enable session logging to S3 and CloudWatch with encryption",id:"enable-session-logging-to-s3-and-cloudwatch-with-encryption",level:2},{value:"What do we need to do?",id:"what-do-we-need-to-do",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h1,{id:"how-to-connect-via-session-manager",children:"How to connect via Session Manager?"}),"\n",(0,a.jsx)(n.h2,{id:"minimal-steps-to-connect",children:"Minimal steps to connect"}),"\n",(0,a.jsx)(n.h3,{id:"ssm-agent",children:"SSM Agent"}),"\n",(0,a.jsx)(n.p,{children:"Prepare Instance/AMI with installed SSM Agent or use one from this list"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html",children:"https://docs.aws.amazon.com/systems-manager/latest/userguide/ami-preinstalled-agent.html"})}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Manually installing SSM Agent on EC2 instances for Linux"}),"\n",(0,a.jsx)(n.p,{children:"Example for Centos Stream:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"#Global resource:\nsudo dnf install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm\n\n#Specific region: us-east-1\nsudo dnf install -y https://s3.us-east-1.amazonaws.com/amazon-ssm-us-east-1/latest/linux_amd64/amazon-ssm-agent.rpm\nsudo systemctl status amazon-ssm-agent\nsudo systemctl enable amazon-ssm-agent\nsudo systemctl start amazon-ssm-agent\n"})}),"\n",(0,a.jsx)(n.p,{children:"Example for Ubuntu 20.10:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"sudo snap install amazon-ssm-agent --classic\nsudo snap list amazon-ssm-agent\nsudo snap start amazon-ssm-agent\nsudo snap services amazon-ssm-agent\n"})}),"\n",(0,a.jsx)(n.p,{children:"Read more:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html",children:"https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-manual-agent-install.html"})}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"iam-instance-profile",children:"IAM instance profile"}),"\n",(0,a.jsxs)(n.p,{children:["Create an IAM instance profile for Systems Manager and attach IAM role to instance (",(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/systems-manager/latest/userguide/setup-instance-profile.html",children:"https://docs.aws.amazon.com/systems-manager/latest/userguide/setup-instance-profile.html"}),")"]}),"\n",(0,a.jsx)(n.p,{children:"Create instance profile:"}),"\n",(0,a.jsx)(n.p,{children:"Important:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"When you create roles for EC2, profile instances are automatically created."}),"\n",(0,a.jsx)(n.li,{children:"If you create roles via AWS CLI the profile instance is not created. You have to create it manually."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"What does it look like with the AWS CLI?"}),"\n",(0,a.jsx)(n.p,{children:"You need a trust policy for the role"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'cat <<EOT >> Role-Trust-Policy.json\n{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Effect": "Allow",\n            "Principal": {\n                "Service": "ec2.amazonaws.com"\n            },\n            "Action": "sts:AssumeRole"\n        }\n    ]\n}\nEOT\n'})}),"\n",(0,a.jsx)(n.p,{children:"Next you need to create a role with necessary policies, instance profile and attach role to instance profile:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"aws iam create-role --role-name Role-SSM-instance --assume-role-policy-document file://Role-Trust-Policy.json\naws iam attach-role-policy --policy-arn arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore --role-name Role-SSM-instance\n\naws iam create-instance-profile --instance-profile-name SSM\naws iam add-role-to-instance-profile --role-name Role-SSM-instance --instance-profile-name Role-SSM-instance\n"})}),"\n",(0,a.jsx)(n.p,{children:"You can see the result:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"aws iam list-instance-profiles\n"})}),"\n",(0,a.jsx)(n.p,{children:"Now we can associate IAM instance profile to the instance:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"aws ec2 associate-iam-instance-profile --instance-id INSTANCE_ID --iam-instance-profile Name=SSM \n"})}),"\n",(0,a.jsx)(n.p,{children:"Read more:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["IAM roles and instance profile ",(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html",children:"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html"})]}),"\n",(0,a.jsxs)(n.li,{children:["Instance Profile ",(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/cli/latest/reference/iam/create-instance-profile.html",children:"https://docs.aws.amazon.com/cli/latest/reference/iam/create-instance-profile.html"})]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"allow-https-traffic-in-security-group",children:"Allow HTTPS traffic in Security Group"}),"\n",(0,a.jsx)(n.p,{children:"Security group added to VPC endpoint must allow inbound HTTPS (port 443) traffic from the resources in your VPC that communicate with the service. In SG for EC2, we do not need to allow HTTPS traffic just to set up a connection with Session Manager."}),"\n",(0,a.jsx)(n.p,{children:"The security group must allow inbound HTTPS (port 443) traffic from the resources in your VPC that communicate with the service."}),"\n",(0,a.jsx)(n.p,{children:"This is an example for AWS CLI:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"aws ec2 authorize-security-group-ingress \\\n    --group-id sg-ID-Security-Group \\\n    --protocol tcp \\\n    --port 443 \\\n    --source-group sg-1a2b3c4d\n"})}),"\n",(0,a.jsx)(n.p,{children:"Read more:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://aws.amazon.com/premiumsupport/knowledge-center/connect-http-https-ec2/",children:"https://aws.amazon.com/premiumsupport/knowledge-center/connect-http-https-ec2/"})}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"connecting-to-instance",children:"Connecting to instance"}),"\n",(0,a.jsx)(n.h3,{id:"aws-management-console",children:"AWS Management Console"}),"\n",(0,a.jsx)(n.p,{children:"To start a session (Amazon EC2 console)"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["Open the Amazon EC2 console at ",(0,a.jsx)(n.a,{href:"https://console.aws.amazon.com/ec2/",children:"https://console.aws.amazon.com/ec2/"}),"."]}),"\n",(0,a.jsx)(n.li,{children:"In the navigation pane, choose Instances."}),"\n",(0,a.jsx)(n.li,{children:"Select the instance and choose Connect."}),"\n",(0,a.jsx)(n.li,{children:"For Connection method, choose Session Manager."}),"\n",(0,a.jsx)(n.li,{children:"Choose Connect."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Read more:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Start a session: ",(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-sessions-start.html",children:"https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-sessions-start.html"})]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"aws-command-line-interface",children:"AWS Command Line Interface"}),"\n",(0,a.jsx)(n.p,{children:"You need to use this command from your local instance or CloudShell"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"aws ssm start-session --target instance-id\n"})}),"\n",(0,a.jsx)(n.p,{children:"Read more:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Start a session: ",(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-sessions-starthtml#sessions-start-cli",children:"https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-sessions-starthtml#sessions-start-cli"})]}),"\n",(0,a.jsxs)(n.li,{children:["CloudShell ",(0,a.jsx)(n.a,{href:"https://aws.amazon.com/cloudshell/",children:"https://aws.amazon.com/cloudshell/"})]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"enable-session-logging-to-s3-and-cloudwatch-with-encryption",children:"Enable session logging to S3 and CloudWatch with encryption"}),"\n",(0,a.jsx)(n.p,{children:"You can log session commands and details in an Amazon S3 bucket or CloudWatch Logs log group.\nConfigure sessions on the Session Manager Preferences page for CloudWatch logging or S3 logging."}),"\n",(0,a.jsx)(n.p,{children:"Important:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Each command together with the output is logged."}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Logs are only collected for Session Manager connections."}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"The log stream is separate for each session in CloudWatch and have the time when this command executed."}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"The logs are recorded in real time in CloudWatch."}),"\n"]}),"\n",(0,a.jsx)(n.li,{}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"In S3 we can see separate files for each session."}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Logs are recorded after the session ends on S3."}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"On S3 We do not have the time when the command was executed, only the start and end of the session."}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Read more:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Logging session activity ",(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-logging.html",children:"https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-logging.html"})]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"what-do-we-need-to-do",children:"What do we need to do?"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"General"}),"\n"]}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Create a KMS key for encryption and set up the key policy to grant permission to the IAM role that will be used for session logging."}),"\n",(0,a.jsx)(n.li,{children:"Update an IAM policy that allows access to the S3 bucket and CloudWatch Logs for session logging."}),"\n"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"S3"}),"\n"]}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Create an S3 bucket for storing session logs with encryption."}),"\n",(0,a.jsx)(n.li,{children:'In the Session Manager settings, enable "Send session logs to S3" and "Choose a bucket name from the list". You can Enforce encryption.'}),"\n"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"CloudWatch"}),"\n"]}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Create a CloudWatch Log Group for storing session logs with encryption."}),"\n",(0,a.jsx)(n.li,{children:"Update an IAM policy that allows access to the S3 bucket and CloudWatch Logs for session logging and using KMS key."}),"\n",(0,a.jsx)(n.li,{children:'In the Session Manager settings, enable "CloudWatch logging", choose "Stream session logs" and "Choose a log group name from the list". You can Enforce encryption.'}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Additional ways to configure Session Manager Preferences:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"AWS CLI"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",metastring:"SessionManagerRunShell.json",children:'{\n    "schemaVersion": "1.0",\n    "description": "Document to hold regional settings for Session Manager",\n    "sessionType": "Standard_Stream",\n    "inputs": {\n        "s3BucketName": "bucket-s3-logs-sessionmanager",\n        "s3KeyPrefix": "ec2session",\n        "s3EncryptionEnabled": true,\n        "cloudWatchLogGroupName": "EC2Session",\n        "cloudWatchEncryptionEnabled": true,\n        "cloudWatchStreamingEnabled": true,\n        "kmsKeyId": "",\n        "runAsEnabled": false,\n        "runAsDefaultUser": "",\n        "idleSessionTimeout": "",\n        "maxSessionDuration": "",\n        "shellProfile": {\n            "windows": "",\n            "linux": ""\n        }\n    }\n}\n'})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'aws ssm update-document --name "SSM-SessionManagerRunShell" --content "file://SessionManagerRunShell.json" --document-version "\\$LATEST"\n'})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"CloudFormation with CustomResources. Preparing Lambda function and run this. (included configuration in the CloudFormation template).\nIf you want automated this, you can use this solution. I added to CloudFormation template at the end this file.\nBrief information: During CF create, there are running another stack with EC2 instance. To EC2 instnane you send the command. You can put Log group name to create and collect logs from this instance. This is usefull during occurs the problems. You need to prepare IAM role/ Instance Profile for this EC2 with necessary permission to run the command. Unfortuantely this take more time to finish the CF stack."}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Using AWSUtility::CloudFormation::CommandRunner. This creates an instance EC2 to run the command."}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Read more:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["AWSUtility::CloudFormation::CommandRunner ",(0,a.jsx)(n.a,{href:"https://aws.amazon.com/premiumsupport/knowledge-center/cloudformation-commandrunner-stack/",children:"https://aws.amazon.com/premiumsupport/knowledge-center/cloudformation-commandrunner-stack/"})]}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/systems-manager/latest/userguide/getting-started-configure-preferences-cli.html",children:"https://docs.aws.amazon.com/systems-manager/latest/userguide/getting-started-configure-preferences-cli.html"})}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Warnning:"}),(0,a.jsx)(n.br,{}),"\n","In this case, there is a potential risk of data leakage. Imagine setting up a configuration under SSM Prefernace and collecting logs in S3 without forcing encryption. We resigned from the solution and we deleted the S3. External account create the bucket S3 with the same name what in our configuration. What is happening?\nOur logs are saved to this bucket! This is our all session. We can open some confidential file or all share our configuration."]}),"\n",(0,a.jsx)(n.p,{children:'If we use "Enforce encryption" we can get this error:\nYour session has been terminated for the following reasons: Couldn\'t start the session because we are unable to validate encryption on Amazon S3 bucket. Error: AccessDenied: Access Denied status code: 403'}),"\n",(0,a.jsx)(n.p,{children:"If not we can put session file to bucket, where permission are appropriate."}),"\n",(0,a.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"One of the less transparent cases that can occur:"}),"\n"]}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"Your session has been terminated for the following reasons: We couldn't start the session because encryption is not set up on the selected CloudWatch Logs log group. Either encrypt the log group or choose an option to enable logging without encryption."}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"and a sample solution:"}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsx)(n.p,{children:"Add a policy to the IAM instance profile that is attached to your instance granting permission to upload encrypted logs to CloudWatch"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Read more:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["CloudWatch ",(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/encrypt-log-data-kms.html",children:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/encrypt-log-data-kms.html"})]}),"\n",(0,a.jsxs)(n.li,{children:["Create a custom IAM role for Session Manager ",(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/systems-manager/latest/userguide/getting-started-create-iam-instance-profile.html#create-iam-instance-profile-ssn-logging",children:"https://docs.aws.amazon.com/systems-manager/latest/userguide/getting-started-create-iam-instance-profile.html#create-iam-instance-profile-ssn-logging"})]}),"\n",(0,a.jsxs)(n.li,{children:["Troubleshoot ",(0,a.jsx)(n.a,{href:"https://aws.amazon.com/premiumsupport/knowledge-center/ssm-session-manager-failures/",children:"https://aws.amazon.com/premiumsupport/knowledge-center/ssm-session-manager-failures/"})]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>i,x:()=>r});var a=s(6540);const t={},o=a.createContext(t);function i(e){const n=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),a.createElement(o.Provider,{value:n},e.children)}}}]);